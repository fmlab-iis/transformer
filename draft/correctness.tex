\todo{for the case that return variables appear in the invariant of the pre-state, we replace it with true in the summary, we should do the same for the summary generated here}
We are ready to sketch the proof of Theorem~\ref{theorem:soundness}. 
Assume Algorithm~\ref{algorithm:overview} returns $\mathit{Pass} (\Pi
(G^-_k, \mathtt{true}))$ and $S[\bullet]$ on the input control flow graph $G =
\langle V, E, \textmd{cmd}, \overline{\mathtt{u}}, \overline{\mathtt{r}},s,e \rangle$. Let $G^-_k = \langle V^-_k, E^-_k,
\textmd{cmd}^-_k , \overline{\mathtt{u}}, \overline{\mathtt{r}},s,e \rangle$ and $\Pi (G^-_k, \mathtt{true}) = \{ I^-_{\ell}
: \ell \in V_k \}$. By the definition of inductive invariants, we have
$\assert{I^-_{\ell}}\ \textmd{cmd}^-_k (\ell, \ell')\ \assert{I^-_{\ell'}}$
for every $(\ell, \ell') \in E^-_k$. Moreover, $V \subseteq V^-_k$ since
$G^-_k$ is obtained by unwinding $G$. Define 
$\Gamma (G, \mathtt{true}) = \{ I^-_{\ell} \in \Pi (G^-_k,
\mathtt{true}) : \ell \in V \}$. We claim $\Gamma (G, \mathtt{true})$
is in fact an inductive invariant for $G$. 

Let $\hat{E} = \{ (\ell, \ell') \in E : \textmd{cmd} (\ell, \ell') =
\overline{\mathtt{x}} := \mathtt{f} (\overline{E}) \}$. We have
$\textmd{cmd} (\ell, \ell') = \textmd{cmd}^-_k (\ell, \ell')$ for every
$(\ell, \ell') \in E \setminus \hat{E}$. Thus $\assert{I^-_{\ell}}\
\textmd{cmd} (\ell, \ell')\ \assert{I^-_{\ell'}}$ for every $(\ell,
\ell') \in E \setminus \hat{E}$ by the definition of $\Gamma (G,
\mathtt{true})$ and the inductiveness of $\Pi (G^-_k,
\mathtt{true})$. It suffices to show that
\begin{equation*}
  \assert{I^-_{\ell}}\
  \overline{\mathtt{x}} := \mathtt{f} (\overline{\mathtt{a}})
  \ \assert{I^-_{\ell'}}
  \hspace{0.5em}
  \textmd{or, equivalently,}
  \hspace{0.5em}
  \assert{I^-_{\ell}}\ 
  \overline{\mathtt{u}} := \overline{\mathtt{a}};\ 
  \mathtt{\overline{r}} := \mathtt{f} (\overline{\mathtt{u}});\ 
  \overline{\mathtt{x}} := \mathtt{\overline{r}}
  \ \assert{I^-_{\ell'}}
\end{equation*}
for every $(\ell, \ell') \in \hat{E}$. 
By the inductiveness of $\Pi (G^-_k, \mathtt{true})$, we have
$\assert{I^-_{\ell}}\ \overline{\mathtt{u}} := \overline{\mathtt{a}}\
\assert{I^-_{s_k^\fun{f}}}$ and
$\assert{I^-_{e_k^\fun{f}}}\ \overline{\mathtt{x}} :=
\mathtt{\overline{r}}\ \assert{I^-_{\ell'}}$. 
Moreover,
$\assert{I^-_{s_k^\mathtt{f}}}\
\mathtt{\overline{r}} := \mathtt{f}
(\overline{\mathtt{u}})\ \assert{I^-_{s_k^\fun{f}}}$ 
by Proposition~\ref{propposition:invariant}
and
$\assert{\mathtt{true}}\ \mathtt{\overline{r}} := \mathtt{f}
(\overline{\mathtt{u}})\ \assert{(I^-_{s_k^\fun{f}} \implies
  I^-_{e_k^\fun{f}})}$ by Proposition~\ref{propposition:strengthen_postcondition} and \ref{proposition:check_summary}.
Since $I^-_{s_k^\fun{f}} \implies \mathtt{true}$, we have
$\assert{I^-_{s_k^\fun{f}}}\
\mathtt{\overline{r}} := \mathtt{f}
(\overline{\mathtt{u}})\  \assert{I^-_{s_k^\fun{f}}
  \implies I^-_{e_k^\fun{f}}}$. Therefore
\begin{prooftree}
  \AxiomC{$\assert{I^-_{\ell}}\
    \overline{\mathtt{u}} := \overline{\mathtt{a}}\ 
    \assert{I^-_{s_k^\fun{f}}}$}

    \AxiomC{$\assert{I^-_{s_k^\fun{f}}}\ 
    \mathtt{\overline{r}} := \mathtt{f} (\overline{\mathtt{u}})\ 
    \assert{I^-_{s_k^\fun{f}}}$}
    \noLine
    \UnaryInfC{$\assert{I^-_{s_k^\fun{f}}}\ 
    \mathtt{\overline{r}} := \mathtt{f} (\overline{\mathtt{u}})\ 
    \assert{I^-_{s_k^\fun{f}} \implies I^-_{e_k^\fun{f}}}$}

  \UnaryInfC{$\assert{I^-_{s_k^\fun{f}}}\ 
    \mathtt{\overline{r}} := \mathtt{f} (\overline{\mathtt{u}})\ 
    \assert{I^-_{e_k^\fun{f}}}$}

  \AxiomC{$\assert{I^-_{e_k^\fun{f}}}\ 
    \overline{\mathtt{x}} := \mathtt{\overline{r}}\ 
    \assert{I^-_{\ell'}}$}

  \TrinaryInfC{$\assert{I^-_{\ell}}\ 
    \overline{\mathtt{u}} := \overline{\mathtt{a}};\ 
    \mathtt{\overline{r} := \mathtt{f} (\overline{\mathtt{u}});\ 
    \overline{\mathtt{x}} := \mathtt{\overline{r}}}\ 
    \assert{I^-_{\ell'}}$}
  \UnaryInfC{$\assert{I^-_{\ell}}\ 
    \overline{\mathtt{x}} := \mathtt{f} (\overline{\mathtt{a}})\ 
    \assert{I^-_{\ell'}}$}
\end{prooftree}